name: Docker build and deploy action
description: Docker image build and deploy into artifactory
author: DA Team <da.team@sherwin.com>
inputs:
  buildcontext:
    description: 'Build Context'
    default: '.'
    required: false

  artifactory_registry:
    description: 'Artifactory URL'
    default: '.'
    required: true

  artifactory_username:
    description: 'Artifactory Username'
    default: '.'
    required: true

  artifactory_api_key:
    description: 'Artifactory API KEY'
    default: '.'
    required: true
  dockerfile_path:
    description: 'Dockerfile Path'
    default: 'Dockerfile'
    required: false
  docker_build_args:
    description: 'Dockerfile Build Arguments'
    default: ''
    required: false
  image_name:
    description: 'Dockerfile Build Arguments'
    default: '${{github.repository}}'
    required: false

runs:
  using: "composite"
  steps:
    - name: Setup docker context for buildx
      id: buildx-context
      run: |
        if [ docker context inspect builders ]
        then
          echo "Docker Builders context exist!!"
        else
          docker context create builders
        fi
      shell: bash
    - name: Setup docker buildx
      uses: docker/setup-buildx-action@v1
      with:
        endpoint: builders
        driver-opts: image=docker.artifactory.sherwin.com/sherwin-williams-co/sw-moby-buildkit:5

    - name: Log in to artifactory docker registry
      uses: docker/login-action@v1
      with:
        registry: '${{ inputs.artifactory_registry }}'
        username: '${{ inputs.artifactory_username }}'
        password: '${{ inputs.artifactory_api_key }}'

    - name: convert reponame to lowercase
      id: lowercasereponame
      run: |
        repoName=`echo "${{inputs.image_name}}" | tr '[:upper:]' '[:lower:]'`
        echo "::set-output name=git_repo_name::${repoName}"
      shell: bash
    - name: Build and publish container image
      uses: docker/build-push-action@v2
      with:
        push: true
        context: '${{ inputs.buildcontext }}'
        file: '${{inputs.dockerfile_path}}'
        build-args: '${{inputs.docker_build_args}}'
        tags: |
          ${{inputs.artifactory_registry}}/${{steps.lowercasereponame.outputs.git_repo_name}}:${{ github.RUN_NUMBER }}
          ${{inputs.artifactory_registry}}/${{steps.lowercasereponame.outputs.git_repo_name}}:latest


branding:
  icon: git-branch
  color: white
