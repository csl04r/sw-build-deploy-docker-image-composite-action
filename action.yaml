name: Docker build and deploy action
description: Docker image build and deploy into artifactory
author: DA Team <da.team@sherwin.com>
inputs:
  buildcontext:
    description: 'Build Context'
    default: '.'
    required: false

runs:
  using: "composite"
  steps:
    - name: Remove docker context for buildx
      continue-on-error: true
      id: remove-buildx-context
      run: |
        docker context rm -f builders
      shell: bash   
    - name: Setup docker context for buildx
      continue-on-error: true
      id: buildx-context
      run: |
        docker context create builders
      shell: bash
    - name: Setup docker buildx
      uses: docker/setup-buildx-action@v1
      with:
        endpoint: builders
        driver-opts: image=docker.artifactory.sherwin.com/sherwin-williams-co/sw-moby-buildkit:5
    
    - name: Log in to artifactory docker registry
      uses: docker/login-action@v1
      with:
        registry: ${{ secrets.ARTIFACTORY_REGISTRY }}
        username: ${{ secrets.ARTIFACTORY_USERNAME }}
        password: ${{ secrets.ARTIFACTORY_API_KEY }}

    - name: convert reponame to lowercase
      id: lowercasereponame
      run: |
        repoName=`echo "${{github.repository}}" | tr '[:upper:]' '[:lower:]'`
        echo "::set-output name=git_repo_name::${repoName}"
      shell: bash
    - name: Build and publish container image
      uses: docker/build-push-action@v2
      with:
        push: true
        context: ${{ inputs.buildcontext }}
          tags: |
            ${{secrets.ARTIFACTORY_REGISTRY}}/${{ steps.lowercasereponame.outputs.git_repo_name }}:${{ github.RUN_NUMBER }}
            ${{secrets.ARTIFACTORY_REGISTRY}}/${{ steps.lowercasereponame.outputs.git_repo_name }}:latest


branding:
  icon: git-branch
  color: white
